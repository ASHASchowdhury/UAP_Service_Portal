<div class="page-header">
    <h1>My Todo List</h1>
    <p>Manage your tasks and stay organized</p>
</div>

<div class="todos-container">
    <!-- Stats Section -->
    <div class="stats-section">
        <div class="stats-grid" id="todo-stats">
            <div class="loading">Loading stats...</div>
        </div>
    </div>

    <!-- Add Todo Form -->
    <div class="add-todo-section">
        <h3>Add New Task</h3>
        <form id="add-todo-form" class="todo-form">
            <div class="form-row">
                <input type="text" id="todo-title" placeholder="Task title" required>
                <select id="todo-priority">
                    <option value="low">Low Priority</option>
                    <option value="medium" selected>Medium Priority</option>
                    <option value="high">High Priority</option>
                </select>
            </div>
            <textarea id="todo-description" placeholder="Task description (optional)"></textarea>
            <div class="form-row">
                <input type="datetime-local" id="todo-due-date">
                <button type="submit" class="btn-primary">Add Task</button>
            </div>
        </form>
    </div>

    <!-- Filters -->
    <div class="filters-section">
        <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all">All Tasks</button>
            <button class="filter-btn" data-filter="pending">Pending</button>
            <button class="filter-btn" data-filter="in_progress">In Progress</button>
            <button class="filter-btn" data-filter="completed">Completed</button>
            <button class="filter-btn" data-filter="overdue">Overdue</button>
            <button class="filter-btn" data-filter="high_priority">High Priority</button>
        </div>
    </div>

    <!-- Todos List -->
    <div class="todos-list" id="todos-container">
        <div class="loading">Loading tasks...</div>
    </div>
</div>

<style>
.todos-container {
    max-width: 1000px;
    margin: 0 auto;
}

.stats-section {
    margin-bottom: 2rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #3498db;
}

.stat-card.total { border-left-color: #3498db; }
.stat-card.completed { border-left-color: #27ae60; }
.stat-card.pending { border-left-color: #f39c12; }
.stat-card.in-progress { border-left-color: #9b59b6; }
.stat-card.overdue { border-left-color: #e74c3c; }

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #666;
    font-size: 0.9rem;
}

.add-todo-section {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.todo-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.form-row {
    display: flex;
    gap: 1rem;
}

.form-row input, .form-row select {
    flex: 1;
}

#todo-title {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
}

#todo-priority {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
}

#todo-description {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    min-height: 80px;
    resize: vertical;
}

#todo-due-date {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
}

.filters-section {
    margin-bottom: 1.5rem;
}

.filter-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    background: white;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s;
}

.filter-btn.active, .filter-btn:hover {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

.todo-item {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #3498db;
    transition: transform 0.2s;
}

.todo-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.todo-item.priority-high { border-left-color: #e74c3c; }
.todo-item.priority-medium { border-left-color: #f39c12; }
.todo-item.priority-low { border-left-color: #27ae60; }
.todo-item.overdue { border-left-color: #c0392b; background: #fff5f5; }
.todo-item.completed { border-left-color: #27ae60; opacity: 0.8; }

.todo-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.todo-title {
    font-size: 1.2rem;
    font-weight: bold;
    margin: 0;
    flex: 1;
}

.todo-actions {
    display: flex;
    gap: 0.5rem;
}

.todo-meta {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    color: #666;
}

.todo-description {
    margin: 0.5rem 0;
    color: #555;
    line-height: 1.4;
}

.todo-due-date {
    font-size: 0.85rem;
    color: #888;
}

.overdue-badge {
    background: #e74c3c;
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: bold;
}

.status-badge {
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: bold;
}

.status-pending { background: #f39c12; color: white; }
.status-in_progress { background: #9b59b6; color: white; }
.status-completed { background: #27ae60; color: white; }

.priority-badge {
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: bold;
}

.priority-high { background: #e74c3c; color: white; }
.priority-medium { background: #f39c12; color: white; }
.priority-low { background: #27ae60; color: white; }

.no-todos {
    text-align: center;
    padding: 3rem;
    color: #666;
    font-style: italic;
}

.loading {
    text-align: center;
    padding: 2rem;
    color: #666;
}
</style>

<script>
class TodosModule {
    constructor() {
        this.todos = [];
        this.currentFilter = 'all';
    }

    async loadTodos() {
        try {
            const response = await API.get('/api/todos/todos/');
            this.todos = response.data || [];
            this.renderTodos();
            this.loadStats();
        } catch (error) {
            console.error('Failed to load todos:', error);
            UI.showError('Failed to load tasks');
        }
    }

    async loadStats() {
        try {
            const response = await API.get('/api/todos/todos/stats/');
            this.renderStats(response.data);
        } catch (error) {
            console.error('Failed to load stats:', error);
        }
    }

    renderStats(stats) {
        const container = document.getElementById('todo-stats');
        container.innerHTML = `
            <div class="stat-card total">
                <div class="stat-number">${stats.total}</div>
                <div class="stat-label">Total Tasks</div>
            </div>
            <div class="stat-card completed">
                <div class="stat-number">${stats.completed}</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card pending">
                <div class="stat-number">${stats.pending}</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card in-progress">
                <div class="stat-number">${stats.in_progress}</div>
                <div class="stat-label">In Progress</div>
            </div>
            <div class="stat-card overdue">
                <div class="stat-number">${stats.overdue}</div>
                <div class="stat-label">Overdue</div>
            </div>
        `;
    }

    renderTodos() {
        const container = document.getElementById('todos-container');
        const filteredTodos = this.getFilteredTodos();

        if (filteredTodos.length === 0) {
            container.innerHTML = '<div class="no-todos">No tasks found</div>';
            return;
        }

        container.innerHTML = filteredTodos.map(todo => `
            <div class="todo-item priority-${todo.priority} ${todo.is_overdue ? 'overdue' : ''}">
                <div class="todo-header">
                    <h3 class="todo-title">${todo.title}</h3>
                    <div class="todo-actions">
                        ${todo.status !== 'completed' ? `
                            <button class="btn-success" onclick="todosModule.updateStatus(${todo.id}, 'completed')">Complete</button>
                            ${todo.status !== 'in_progress' ? `<button class="btn-warning" onclick="todosModule.updateStatus(${todo.id}, 'in_progress')">Start</button>` : ''}
                        ` : ''}
                        ${todo.status === 'completed' ? `
                            <button class="btn-warning" onclick="todosModule.updateStatus(${todo.id}, 'pending')">Reopen</button>
                        ` : ''}
                        <button class="btn-danger" onclick="todosModule.deleteTodo(${todo.id})">Delete</button>
                    </div>
                </div>
                <div class="todo-meta">
                    <span class="status-badge status-${todo.status}">${todo.status.replace('_', ' ').toUpperCase()}</span>
                    <span class="priority-badge priority-${todo.priority}">${todo.priority.toUpperCase()} PRIORITY</span>
                    ${todo.is_overdue ? '<span class="overdue-badge">OVERDUE</span>' : ''}
                </div>
                ${todo.description ? `<div class="todo-description">${todo.description}</div>` : ''}
                ${todo.due_date ? `
                    <div class="todo-due-date">
                        Due: ${new Date(todo.due_date).toLocaleString()}
                    </div>
                ` : ''}
            </div>
        `).join('');
    }

    getFilteredTodos() {
        switch (this.currentFilter) {
            case 'pending':
                return this.todos.filter(todo => todo.status === 'pending');
            case 'in_progress':
                return this.todos.filter(todo => todo.status === 'in_progress');
            case 'completed':
                return this.todos.filter(todo => todo.status === 'completed');
            case 'overdue':
                return this.todos.filter(todo => todo.is_overdue);
            case 'high_priority':
                return this.todos.filter(todo => todo.priority === 'high');
            default:
                return this.todos;
        }
    }

    async addTodo(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = {
            title: document.getElementById('todo-title').value,
            description: document.getElementById('todo-description').value,
            priority: document.getElementById('todo-priority').value,
            due_date: document.getElementById('todo-due-date').value || null,
        };

        try {
            await API.post('/api/todos/todos/', formData);
            UI.showSuccess('Task added successfully');
            form.reset();
            this.loadTodos();
        } catch (error) {
            console.error('Failed to add todo:', error);
            UI.showError('Failed to add task');
        }
    }

    async updateStatus(todoId, status) {
        try {
            const endpoint = `/api/todos/todos/${todoId}/${this.getStatusEndpoint(status)}/`;
            await API.post(endpoint);
            UI.showSuccess('Task updated successfully');
            this.loadTodos();
        } catch (error) {
            console.error('Failed to update todo:', error);
            UI.showError('Failed to update task');
        }
    }

    getStatusEndpoint(status) {
        const endpoints = {
            'completed': 'mark_complete',
            'in_progress': 'mark_in_progress',
            'pending': 'mark_pending'
        };
        return endpoints[status];
    }

    async deleteTodo(todoId) {
        if (!confirm('Are you sure you want to delete this task?')) {
            return;
        }

        try {
            await API.delete(`/api/todos/todos/${todoId}/`);
            UI.showSuccess('Task deleted successfully');
            this.loadTodos();
        } catch (error) {
            console.error('Failed to delete todo:', error);
            UI.showError('Failed to delete task');
        }
    }

    setFilter(filter) {
        this.currentFilter = filter;
        
        // Update active button
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.filter === filter);
        });
        
        this.renderTodos();
    }
}

const todosModule = new TodosModule();

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Load todos
    todosModule.loadTodos();
    
    // Setup form submission
    document.getElementById('add-todo-form').addEventListener('submit', (e) => todosModule.addTodo(e));
    
    // Setup filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => todosModule.setFilter(btn.dataset.filter));
    });
});
</script>
